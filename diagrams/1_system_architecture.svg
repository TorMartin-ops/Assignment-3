<?xml version="1.0" encoding="UTF-8"?>
<svg width="100%" height="100%" viewBox="0 0 1600 2100"
     xmlns="http://www.w3.org/2000/svg">
  <title>System Architecture - Authentication System</title>
  <desc>Complete architecture verified against codebase with file:line references</desc>
  <defs>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&amp;display=swap');
      text { font-family: 'Inter', system-ui, sans-serif; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#6B7280" />
    </marker>
  </defs>
  <text x="800" y="50" font-size="24.0" fill="#1E3C72" font-weight="bold" text-anchor="middle">System Architecture - Authentication System</text>
  <rect x="50" y="90" width="1500" height="240" fill="none" stroke="#C82333" stroke-width="3" rx="8" opacity="1" stroke-dasharray="10,5"/>
  <text x="70" y="125" font-size="16" fill="#C82333" font-weight="bold" text-anchor="start">ğŸŒ Trust Boundary: Internet</text>
  <rect x="120" y="150" width="380" height="140" fill="#E3F2FD" stroke="#1E3C72" stroke-width="2" rx="8" opacity="1" />
  <text x="140" y="180" font-size="14" fill="#1E3C72" font-weight="bold" text-anchor="start">Web Browser</text>
  <text x="140" y="210" font-size="12" fill="#000000" font-weight="normal" text-anchor="start">â€¢ User Agent (JavaScript, Cookies)</text>
  <text x="140" y="235" font-size="12" fill="#000000" font-weight="normal" text-anchor="start">â€¢ Secure, HttpOnly, SameSite cookies (app_auth.py:24)</text>
  <text x="140" y="260" font-size="12" fill="#000000" font-weight="normal" text-anchor="start">â€¢ Client-side PKCE (code_verifier)</text>
  <rect x="1100" y="150" width="380" height="140" fill="#FFF3E0" stroke="#B36B00" stroke-width="2" rx="8" opacity="1" />
  <text x="1120" y="180" font-size="14" fill="#B36B00" font-weight="bold" text-anchor="start">External OAuth Provider</text>
  <text x="1120" y="210" font-size="12" fill="#000000" font-weight="normal" text-anchor="start">â€¢ Google, GitHub, etc.</text>
  <text x="1120" y="235" font-size="12" fill="#000000" font-weight="normal" text-anchor="start">â€¢ Future integration</text>
  <rect x="50" y="360" width="1500" height="90" fill="#E8F5E9" stroke="#1E7E34" stroke-width="2" rx="8" opacity="1" />
  <text x="70" y="395" font-size="16" fill="#1E7E34" font-weight="bold" text-anchor="start">ğŸ”’ TLS/HTTPS Layer (Port 5001)</text>
  <text x="70" y="425" font-size="11" fill="#000000" font-weight="normal" text-anchor="start">HTTPS termination, HSTS enforcement (utils/security_headers.py:36)</text>
  <rect x="50" y="480" width="1500" height="1200" fill="none" stroke="#1E3C72" stroke-width="3" rx="8" opacity="1" />
  <text x="70" y="520" font-size="16" fill="#1E3C72" font-weight="bold" text-anchor="start">ğŸ—ï¸ Flask Application (app_auth.py:20)</text>
  <rect x="120" y="560" width="480" height="140" fill="#F3E5F5" stroke="#9C27B0" stroke-width="2" rx="8" opacity="1" />
  <text x="140" y="595" font-size="14" fill="#9C27B0" font-weight="bold" text-anchor="start">Middleware Stack</text>
  <text x="160" y="625" font-size="12" fill="#000000" font-weight="normal" text-anchor="start">ğŸ›¡ï¸ CSRF Protection (app_auth.py:29)</text>
  <text x="160" y="650" font-size="12" fill="#000000" font-weight="normal" text-anchor="start">ğŸ” Security Headers (app_auth.py:53)</text>
  <text x="160" y="675" font-size="12" fill="#000000" font-weight="normal" text-anchor="start">â±ï¸ Rate Limiter (5 req/min)</text>
  <text x="120" y="750" font-size="14" fill="#1E3C72" font-weight="bold" text-anchor="start">Route Blueprints:</text>
  <rect x="120" y="780" width="400" height="180" fill="#E1F5FE" stroke="#1E3C72" stroke-width="2" rx="8" opacity="1" />
  <text x="140" y="815" font-size="14" fill="#1E3C72" font-weight="bold" text-anchor="start">auth_bp (routes/auth_routes.py:12)</text>
  <text x="150" y="845" font-size="12" fill="#000000" font-weight="normal" text-anchor="start">â€¢ /register</text>
  <text x="150" y="870" font-size="12" fill="#000000" font-weight="normal" text-anchor="start">â€¢ /login (line 60)</text>
  <text x="150" y="895" font-size="12" fill="#000000" font-weight="normal" text-anchor="start">â€¢ /logout</text>
  <text x="150" y="920" font-size="12" fill="#000000" font-weight="normal" text-anchor="start">â€¢ /change-password</text>
  <rect x="580" y="780" width="400" height="180" fill="#E1F5FE" stroke="#1E3C72" stroke-width="2" rx="8" opacity="1" />
  <text x="600" y="815" font-size="14" fill="#1E3C72" font-weight="bold" text-anchor="start">oauth_bp (routes/oauth_routes.py:22)</text>
  <text x="610" y="845" font-size="12" fill="#000000" font-weight="normal" text-anchor="start">â€¢ /oauth/authorize (line 35)</text>
  <text x="610" y="870" font-size="12" fill="#000000" font-weight="normal" text-anchor="start">â€¢ /oauth/token (line 133)</text>
  <text x="610" y="895" font-size="12" fill="#000000" font-weight="normal" text-anchor="start">â€¢ /oauth/userinfo (line 214)</text>
  <text x="610" y="920" font-size="12" fill="#000000" font-weight="normal" text-anchor="start">â€¢ /oauth/revoke (line 242)</text>
  <rect x="1040" y="780" width="400" height="180" fill="#E1F5FE" stroke="#1E3C72" stroke-width="2" rx="8" opacity="1" />
  <text x="1060" y="815" font-size="14" fill="#1E3C72" font-weight="bold" text-anchor="start">twofa_bp (routes/twofa_routes.py:12)</text>
  <text x="1070" y="845" font-size="12" fill="#000000" font-weight="normal" text-anchor="start">â€¢ /setup-2fa (line 21)</text>
  <text x="1070" y="870" font-size="12" fill="#000000" font-weight="normal" text-anchor="start">â€¢ /verify-2fa (line 82)</text>
  <text x="1070" y="895" font-size="12" fill="#000000" font-weight="normal" text-anchor="start">â€¢ /backup-codes</text>
  <text x="1070" y="920" font-size="12" fill="#000000" font-weight="normal" text-anchor="start">â€¢ /disable-2fa (line 171)</text>
  <text x="120" y="1010" font-size="14" fill="#1E3C72" font-weight="bold" text-anchor="start">Service Layer (Singletons):</text>
  <rect x="120" y="1040" width="280" height="140" fill="#E8F5E9" stroke="#1E7E34" stroke-width="2" rx="8" opacity="1" />
  <text x="135" y="1070" font-size="14" fill="#1E7E34" font-weight="bold" text-anchor="start">AuthService</text>
  <text x="135" y="1095" font-size="11" fill="#6B7280" font-weight="normal" text-anchor="start">(services/auth_service.py:13)</text>
  <text x="140" y="1120" font-size="11" fill="#000000" font-weight="normal" text-anchor="start">Argon2id: t=2, m=19456, p=1</text>
  <text x="140" y="1142" font-size="11" fill="#000000" font-weight="normal" text-anchor="start">Timing-safe authentication</text>
  <rect x="420" y="1040" width="280" height="140" fill="#E8F5E9" stroke="#1E7E34" stroke-width="2" rx="8" opacity="1" />
  <text x="435" y="1070" font-size="14" fill="#1E7E34" font-weight="bold" text-anchor="start">OAuth2Service</text>
  <text x="435" y="1095" font-size="11" fill="#6B7280" font-weight="normal" text-anchor="start">(services/oauth2_service.py:14)</text>
  <text x="440" y="1120" font-size="11" fill="#000000" font-weight="normal" text-anchor="start">PKCE (S256) line 98</text>
  <text x="440" y="1142" font-size="11" fill="#000000" font-weight="normal" text-anchor="start">Token Rotation line 290</text>
  <rect x="720" y="1040" width="280" height="140" fill="#E8F5E9" stroke="#1E7E34" stroke-width="2" rx="8" opacity="1" />
  <text x="735" y="1070" font-size="14" fill="#1E7E34" font-weight="bold" text-anchor="start">TOTPService</text>
  <text x="735" y="1095" font-size="11" fill="#6B7280" font-weight="normal" text-anchor="start">(services/totp_service.py:16)</text>
  <text x="740" y="1120" font-size="11" fill="#000000" font-weight="normal" text-anchor="start">pyotp, QR Code line 36</text>
  <text x="740" y="1142" font-size="11" fill="#000000" font-weight="normal" text-anchor="start">Replay Prevention line 130</text>
  <rect x="1020" y="1040" width="280" height="140" fill="#E8F5E9" stroke="#1E7E34" stroke-width="2" rx="8" opacity="1" />
  <text x="1035" y="1070" font-size="14" fill="#1E7E34" font-weight="bold" text-anchor="start">RateLimiter</text>
  <text x="1035" y="1095" font-size="11" fill="#6B7280" font-weight="normal" text-anchor="start">(services/rate_limiter.py:11)</text>
  <text x="1040" y="1120" font-size="11" fill="#000000" font-weight="normal" text-anchor="start">Database-backed</text>
  <text x="1040" y="1142" font-size="11" fill="#000000" font-weight="normal" text-anchor="start">BEGIN IMMEDIATE line 96</text>
  <rect x="120" y="1210" width="280" height="140" fill="#E8F5E9" stroke="#1E7E34" stroke-width="2" rx="8" opacity="1" />
  <text x="135" y="1240" font-size="14" fill="#1E7E34" font-weight="bold" text-anchor="start">SecurityService</text>
  <text x="135" y="1265" font-size="11" fill="#6B7280" font-weight="normal" text-anchor="start">(services/security_service.py:9)</text>
  <text x="140" y="1290" font-size="11" fill="#000000" font-weight="normal" text-anchor="start">3 failures â†’ 15min lockout</text>
  <text x="140" y="1312" font-size="11" fill="#000000" font-weight="normal" text-anchor="start">CAPTCHA after 3 failures</text>
  <rect x="420" y="1210" width="280" height="140" fill="#E8F5E9" stroke="#1E7E34" stroke-width="2" rx="8" opacity="1" />
  <text x="435" y="1240" font-size="14" fill="#1E7E34" font-weight="bold" text-anchor="start">EncryptionService</text>
  <text x="435" y="1265" font-size="11" fill="#6B7280" font-weight="normal" text-anchor="start">(utils/encryption.py:16)</text>
  <text x="440" y="1290" font-size="11" fill="#000000" font-weight="normal" text-anchor="start">Fernet (AES-128 CBC)</text>
  <text x="440" y="1312" font-size="11" fill="#000000" font-weight="normal" text-anchor="start">PBKDF2: 100k iterations</text>
  <rect x="120" y="1410" width="1320" height="240" fill="#E3F2FD" stroke="#1E3C72" stroke-width="2" rx="8" opacity="1" />
  <text x="140" y="1450" font-size="14" fill="#1E3C72" font-weight="bold" text-anchor="start">ğŸ’¾ SQLite Database (database_auth.py:9)</text>
  <text x="160" y="1485" font-size="12" fill="#000000" font-weight="normal" text-anchor="start">â€¢ users (line 22, 16 columns, totp_secret encrypted)</text>
  <text x="160" y="1513" font-size="12" fill="#000000" font-weight="normal" text-anchor="start">â€¢ login_attempts (line 87, 7 columns, 2 indexes)</text>
  <text x="160" y="1541" font-size="12" fill="#000000" font-weight="normal" text-anchor="start">â€¢ account_lockouts (line 113, 7 columns)</text>
  <text x="160" y="1569" font-size="12" fill="#000000" font-weight="normal" text-anchor="start">â€¢ rate_limits (line 133, 6 columns)</text>
  <text x="160" y="1597" font-size="12" fill="#000000" font-weight="normal" text-anchor="start">â€¢ security_events (line 153, 9 columns)</text>
  <text x="780" y="1485" font-size="12" fill="#000000" font-weight="normal" text-anchor="start">â€¢ oauth2_clients (line 180, 13 columns)</text>
  <text x="780" y="1513" font-size="12" fill="#000000" font-weight="normal" text-anchor="start">â€¢ oauth2_authorization_codes (line 209)</text>
  <text x="780" y="1541" font-size="12" fill="#000000" font-weight="normal" text-anchor="start">â€¢ oauth2_tokens (line 235, family tracking)</text>
  <text x="780" y="1569" font-size="12" fill="#000000" font-weight="normal" text-anchor="start">â€¢ sessions (line 274, fingerprinting)</text>
  <text x="120" y="1710" font-size="14" fill="#1E3C72" font-weight="bold" text-anchor="start">External Services:</text>
  <rect x="120" y="1750" width="580" height="110" fill="#FFEBEE" stroke="#C82333" stroke-width="2" rx="8" opacity="1" />
  <text x="140" y="1785" font-size="14" fill="#C82333" font-weight="bold" text-anchor="start">ğŸŒ Google reCAPTCHA v2 (utils/recaptcha.py:10)</text>
  <text x="150" y="1815" font-size="12" fill="#000000" font-weight="normal" text-anchor="start">Triggered after 3 login failures (routes/auth_routes.py:78)</text>
  <text x="150" y="1840" font-size="12" fill="#000000" font-weight="normal" text-anchor="start">Site key in template context</text>
  <rect x="760" y="1750" width="680" height="110" fill="#FFF3E0" stroke="#B36B00" stroke-width="2" rx="8" opacity="1" />
  <text x="780" y="1785" font-size="14" fill="#B36B00" font-weight="bold" text-anchor="start">ğŸŒ HaveIBeenPwned API (utils/validators.py:82)</text>
  <text x="790" y="1815" font-size="12" fill="#000000" font-weight="normal" text-anchor="start">k-anonymity password breach checking</text>
  <text x="790" y="1840" font-size="12" fill="#000000" font-weight="normal" text-anchor="start">SHA-1 prefix query (5 hex chars) - line 88</text>
  <path d="M 310,290 L 310,360" stroke="#6B7280" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <text x="330" y="325" font-size="12" fill="#6B7280" font-weight="normal" text-anchor="start">HTTPS Request</text>
  <path d="M 310,450 L 310,560" stroke="#6B7280" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <text x="330" y="505" font-size="12" fill="#6B7280" font-weight="normal" text-anchor="start">Decrypted</text>
  <path d="M 360,700 L 360,780" stroke="#6B7280" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <text x="380" y="740" font-size="12" fill="#6B7280" font-weight="normal" text-anchor="start">Route Handler</text>
  <path d="M 320,960 L 260,1040" stroke="#6B7280" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <text x="270" y="1000" font-size="12" fill="#6B7280" font-weight="normal" text-anchor="start">AuthService</text>
  <path d="M 780,960 L 560,1040" stroke="#6B7280" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <text x="670" y="1000" font-size="12" fill="#6B7280" font-weight="normal" text-anchor="start">OAuth2Service</text>
  <path d="M 1240,960 L 860,1040" stroke="#6B7280" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <text x="1050" y="1000" font-size="12" fill="#6B7280" font-weight="normal" text-anchor="start">TOTPService</text>
  <path d="M 260,1180 L 500,1410" stroke="#6B7280" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <text x="380" y="1295" font-size="12" fill="#6B7280" font-weight="normal" text-anchor="start">Database Queries</text>
  <path d="M 180,1350 L 300,1750" stroke="#6B7280" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <text x="200" y="1550" font-size="12" fill="#6B7280" font-weight="normal" text-anchor="start">reCAPTCHA</text>
  <path d="M 320,1350 L 950,1750" stroke="#6B7280" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <text x="635" y="1550" font-size="12" fill="#6B7280" font-weight="normal" text-anchor="start">HaveIBeenPwned</text>
  <rect x="50" y="1920" width="1500" height="160" fill="#FAFAFA" stroke="#6B7280" stroke-width="1" rx="8" opacity="1" />
  <text x="70" y="1960" font-size="14" fill="#6B7280" font-weight="bold" text-anchor="start">Legend:</text>
  <text x="150" y="1960" font-size="11" fill="#6B7280" font-weight="normal" text-anchor="start">â” â” Trust Boundary  |  ğŸ”’ TLS/HTTPS  |  ğŸ›¡ï¸ Middleware  |  ğŸ“‹ Routes  |  âš™ï¸ Services  |  ğŸ’¾ Database  |  ğŸŒ External API</text>
  <text x="70" y="2000" font-size="12" fill="#6B7280" font-weight="bold" text-anchor="start">Trust Boundaries:</text>
  <text x="70" y="2025" font-size="11" fill="#000000" font-weight="normal" text-anchor="start">1. Internet to Application: HTTPS, HSTS, CSP, CSRF tokens, Rate limiting</text>
  <text x="70" y="2050" font-size="11" fill="#000000" font-weight="normal" text-anchor="start">2. Application to Database: Parameterized queries, Transaction isolation (BEGIN IMMEDIATE)</text>
  <text x="70" y="2075" font-size="11" fill="#000000" font-weight="normal" text-anchor="start">3. OAuth2 Client to Server: PKCE, Client auth, Redirect URI exact match</text>
</svg>